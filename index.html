<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>PageBook</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    .container { display: flex; max-width: 1400px; margin: auto; padding: 20px; gap: 20px; }
    .left, .right { flex: 1; }
    .center { flex: 2; background: white; padding: 20px; border-radius: 10px; }
    input, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .post { border-top: 1px solid #ccc; padding-top: 10px; margin-top: 20px; }
    .comment { margin-left: 10px; font-size: 0.9em; }
    .comment-input { width: 80%; padding: 6px; margin-top: 5px; }
    #user-list img { border-radius: 50%; vertical-align: middle; margin-right: 5px; }
    .media iframe, .media audio { width: 100%; margin-top: 10px; }
    .hidden { display: none; }
    .link-button { background: none; border: none; color: blue; text-decoration: underline; cursor: pointer; padding: 0; }
  </style>
</head>
<body>
  <img src="https://placehold.co/1400x200?text=Welcome+to+PageBook" style="width:100%; display:block;" />

  <div class="container">
    <div class="left">
      <div id="auth">
        <input type="text" id="displayName" placeholder="Display Name" class="hidden" />
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <button id="login">Login</button>
        <button id="signup" class="hidden">Register</button>
        <p id="toggle-auth">Don't have an account? <button class="link-button" onclick="toggleSignup(true)">Sign Up</button></p>
        <button id="logout" class="hidden">Logout</button>
      </div>
      <h4>üë• Users</h4>
      <div id="user-list"></div>

      <div class="media">
        <h4>üì∫ Myanmar TV (24/7)</h4>
        <iframe src="'https://www.youtube.com/watch?v=ruHUSKqLBY8'" height="200" allowfullscreen></iframe>
        <h4>üìª FM Radio</h4>
        <audio controls>
          <source src="https://stream.zeno.fm/pxn7p5cbm48uv" type="audio/mpeg">
        </audio>
      </div>
    </div>

    <div class="center">
      <input type="text" id="search" placeholder="Search by Title or Author">
      <form id="post-form" class="hidden">
        <input type="text" id="post-title" placeholder="Post Title" required />
        <input type="text" id="post-name" placeholder="Your Name" required />
        <textarea id="post-text" placeholder="Write your post..." required></textarea>
        <input type="url" id="post-image" placeholder="Image URL (optional)" />
        <button type="submit">Post</button>
      </form>
      <div id="posts"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBevLNp5ZnrnBol3Kp0FCR_uyS1eqcWQCY",
      authDomain: "weminthu-2b12a.firebaseapp.com",
      projectId: "weminthu-2b12a"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const $ = id => document.getElementById(id);
    const postsDiv = $("posts"), userList = $("user-list"), search = $("search");
    let currentUser = null, postsData = [];

    auth.onAuthStateChanged(user => {
      currentUser = user;
      $("post-form").classList.toggle("hidden", !user);
      $("logout").classList.toggle("hidden", !user);
      $("login").classList.toggle("hidden", !!user);
      $("toggle-auth").style.display = user ? "none" : "block";
    });

    $("login").onclick = () => {
      auth.signInWithEmailAndPassword($("email").value, $("password").value).catch(e => alert(e.message));
    };

    $("signup").onclick = async () => {
      const name = $("displayName").value;
      const email = $("email").value;
      const pass = $("password").value;
      const userCred = await auth.createUserWithEmailAndPassword(email, pass);
      await userCred.user.updateProfile({ displayName: name });
      await db.collection("users").doc(userCred.user.uid).set({
        name, email, photo: `https://api.dicebear.com/6.x/initials/svg?seed=${name}`
      });
    };

    $("logout").onclick = () => auth.signOut();

    function toggleSignup(show) {
      $("displayName").classList.toggle("hidden", !show);
      $("signup").classList.toggle("hidden", !show);
      $("login").classList.toggle("hidden", show);
      $("toggle-auth").innerHTML = show
        ? 'Already have an account? <button class="link-button" onclick="toggleSignup(false)">Login</button>'
        : 'Don\'t have an account? <button class="link-button" onclick="toggleSignup(true)">Sign Up</button>';
    }

    $("post-form").onsubmit = async e => {
      e.preventDefault();
      const title = $("post-title").value, name = $("post-name").value, text = $("post-text").value, image = $("post-image").value;
      if (!title || !name || !text) return;
      await db.collection("posts").add({
        title, name, text, image,
        authorName: currentUser.displayName,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        uid: currentUser.uid,
        likes: 0, comments: []
      });
      $("post-form").reset();
    };

    db.collection("users").onSnapshot(snap => {
      userList.innerHTML = "";
      snap.forEach(doc => {
        const u = doc.data();
        userList.innerHTML += `<div><img src="${u.photo}" width="24"> ${u.name}</div>`;
      });
    });

    db.collection("posts").orderBy("createdAt", "desc").onSnapshot(snap => {
      postsData = [];
      snap.forEach(doc => postsData.push({ id: doc.id, ...doc.data() }));
      renderPosts(postsData);
    });

    search.addEventListener("input", () => {
      const val = search.value.toLowerCase();
      renderPosts(postsData.filter(p => p.title.toLowerCase().includes(val) || p.name.toLowerCase().includes(val)));
    });

    function renderPosts(posts) {
      postsDiv.innerHTML = "";
      posts.forEach(p => {
        const isOwner = currentUser && p.uid === currentUser.uid;
        const time = p.createdAt?.toDate().toLocaleString() || "";
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <h4>${p.title}</h4>
          <p><strong>${p.name}</strong> ‚Äî <small>${time}</small></p>
          <p>${p.text}</p>
          ${p.image ? `<img src="${p.image}" style="max-width:100%;">` : ""}
          <div>
            <button onclick="like('${p.id}')">‚ù§Ô∏è Like (${p.likes || 0})</button>
            ${isOwner ? `<button onclick="edit('${p.id}', \`${p.text.replace(/`/g, '\`')}\`)">‚úèÔ∏è Edit</button>
            <button onclick="del('${p.id}')">üóëÔ∏è Delete</button>` : ""}
          </div>
          <div class="comments">
            ${(p.comments || []).map(c => `<div class="comment">üí¨ ${c}</div>`).join("")}
            <input class="comment-input" placeholder="Write a comment..." onkeypress="comment(event, '${p.id}')">
          </div>
        `;
        postsDiv.appendChild(div);
      });
    }

    function like(id) {
      const ref = db.collection("posts").doc(id);
      ref.get().then(snap => ref.update({ likes: (snap.data().likes || 0) + 1 }));
    }

    function edit(id, text) {
      const newText = prompt("Edit your post:", text);
      if (newText) db.collection("posts").doc(id).update({ text: newText });
    }

    function del(id) {
      if (confirm("Delete this post?")) db.collection("posts").doc(id).delete();
    }

    function comment(e, id) {
      if (e.key === "Enter") {
        const val = e.target.value.trim();
        if (val) {
          db.collection("posts").doc(id).update({
            comments: firebase.firestore.FieldValue.arrayUnion(val)
          });
          e.target.value = "";
        }
      }
    }
  </script>
</body>
</html>
